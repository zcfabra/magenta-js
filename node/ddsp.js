!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.mm=n():t.mm=n()}(global,(function(){return function(t){var n={};function e(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,e),r.l=!0,r.exports}return e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:o})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(e.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var r in t)e.d(o,r,function(n){return t[n]}.bind(null,r));return o},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="",e(e.s=30)}([function(t,n){t.exports=require("@tensorflow/tfjs")},,function(t,n){t.exports=require("tone")},,function(t,n,e){"use strict";e.r(n),e.d(n,"Level",(function(){return o})),e.d(n,"verbosity",(function(){return s})),e.d(n,"setVerbosity",(function(){return i})),e.d(n,"log",(function(){return a})),e.d(n,"logWithDuration",(function(){return u}));var o,r=e(6);!function(t){t[t.NONE=0]="NONE",t[t.WARN=5]="WARN",t[t.INFO=10]="INFO",t[t.DEBUG=20]="DEBUG"}(o||(o={}));let s=10;function i(t){t=t}function a(t,n="Magenta.js",e=10){if(0===e)throw Error("Logging level cannot be NONE.");if(s>=e){(5===e?console.warn:console.log)(`%c ${n} `,"background:magenta; color:white",t)}}function u(t,n,e="Magenta.js",o=10){a(`${t} in ${((r.d.now()-n)/1e3).toPrecision(3)}s`,e,o)}},,function(t,n,e){"use strict";e.d(n,"a",(function(){return o})),e.d(n,"d",(function(){return r})),e.d(n,"c",(function(){return s})),e.d(n,"b",(function(){return i}));const o=e(18),r=e(19);e(21);function s(){throw new Error("Cannot check if Safari in Node.js")}function i(t){throw new Error("Cannot use offline audio context in Node.js")}},,function(t,n,e){"use strict";e.d(n,"e",(function(){return l})),e.d(n,"d",(function(){return f})),e.d(n,"f",(function(){return d})),e.d(n,"i",(function(){return h})),e.d(n,"j",(function(){return p})),e.d(n,"a",(function(){return m})),e.d(n,"h",(function(){return y})),e.d(n,"b",(function(){return x})),e.d(n,"g",(function(){return v})),e.d(n,"c",(function(){return j}));var o=e(0),r=e(17),s=e(22),i=e(27),a=e(6),u=e(4);const c=Object(a.b)(16e3);async function l(t){return Object(a.a)(t).then(t=>t.arrayBuffer()).then(t=>c.decodeAudioData(t))}async function f(t){const n=new FileReader;return new Promise((e,o)=>{n.onerror=()=>{n.abort(),o(new DOMException("Something went wrong reading that file."))},n.onload=()=>{e(n.result)},n.readAsArrayBuffer(t)}).then(t=>c.decodeAudioData(t))}function d(t,n){n.power||(n.power=2);const e=function(t,n){const e=n.nFft||2048,o=n.winLength||e,r=n.hopLength||Math.floor(o/4);let s=x(o);s=y(s,e);const i=function(t,n,e){const o=Math.floor((t.length-n)/e)+1,r=Array.from({length:o},(t,e)=>new Float32Array(n));for(let s=0;s<o;s++){const o=s*e,i=t.slice(o,o+n);r[s].set(i),i.length}return r}(t=function(t,n){const e=b(t,n);for(let t=0;t<n;t++)e[t]=e[2*n-t],e[e.length-t-1]=e[e.length-2*n+t-1];return e}(t,Math.floor(e/2)),e,r),a=[],u=i.length,c=e+2;for(let t=0;t<u;t++){const n=new Float32Array(c);a[t]=n}for(let t=0;t<u;t++){const n=M(m(i[t],s));a[t].set(n.slice(0,c))}return a}(t,n),[o,r]=function(t,n){const e=t.map(t=>function(t,n){return t.map(t=>Math.pow(t,n))}(function(t){const n=new Float32Array(t.length/2);for(let e=0;e<t.length/2;e++)n[e]=Math.sqrt(t[2*e]*t[2*e]+t[2*e+1]*t[2*e+1]);return n}(t),n)),o=t[0].length-1;return[e,o]}(e,n.power);n.nFft=r;return function(t,n){const e=[];for(let o=0;o<t.length;o++)e[o]=w(t[o],n);return e}(o,function(t){const n=t.fMin||0,e=t.fMax||t.sampleRate/2,o=t.nMels||128,r=t.nFft||2048,s=function(t,n){return _(0,t/2,Math.floor(1+n/2))}(t.sampleRate,r),i=function(t,n,e){const o=O(n),r=O(e),s=_(o,r,t);return s.map(t=>function(t){return 700*(Math.exp(t/1125)-1)}(t))}(o+2,n,e),a=function(t){const n=new Float32Array(t.length-1);for(let e=0;e<t.length;e++)n[e]=t[e+1]-t[e];return n}(i),u=function(t,n){const e=[];for(let o=0;o<t.length;o++)e[o]=new Float32Array(n.length);for(let o=0;o<t.length;o++)for(let r=0;r<n.length;r++)e[o][r]=t[o]-n[r];return e}(i,s),c=u[0].length,l=[];for(let t=0;t<o;t++){l[t]=new Float32Array(c);for(let n=0;n<u[t].length;n++){const e=-u[t][n]/a[t],o=u[t+2][n]/a[t+1],r=Math.max(0,Math.min(e,o));l[t][n]=r}}for(let t=0;t<l.length;t++){const n=2/(i[2+t]-i[t]);l[t]=l[t].map(t=>t*n)}return l}(n))}function h(t,n=1e-10,e=80){const o=t.length,r=t[0].length,s=[];for(let t=0;t<o;t++)s[t]=new Float32Array(r);for(let e=0;e<o;e++)for(let o=0;o<r;o++){const r=t[e][o];s[e][o]=10*Math.log10(Math.max(n,r))}if(e){if(e<0)throw new Error("topDb must be non-negative.");for(let t=0;t<o;t++){const n=s[t].reduce((t,n)=>Math.max(t,n));for(let o=0;o<r;o++)s[t][o]=Math.max(s[t][o],n-e)}}return s}function g(t){if(1===t.numberOfChannels)return t.getChannelData(0);if(2!==t.numberOfChannels)throw Error(t.numberOfChannels+" channel audio is not supported.");const n=t.getChannelData(0),e=t.getChannelData(1),o=new Float32Array(t.length);for(let r=0;r<t.length;++r)o[r]=(n[r]+e[r])/2;return o}async function p(t,n=16e3){if(t.sampleRate===n)return g(t);const e=t.sampleRate,o=t.length*n/e;if(a.c){u.log("Safari does not support WebAudio resampling, so this may be slow.","O&F",5);const n=g(t),e=new Float32Array(o);return i(s(e,[o]),s(n,[n.length])),e}{const e=new OfflineAudioContext(t.numberOfChannels,t.duration*n,n),o=e.createBufferSource();return o.buffer=t,o.connect(e.destination),o.start(),e.startRendering().then(t=>t.getChannelData(0))}}function w(t,n){if(t.length!==n[0].length)throw new Error(`Each entry in filterbank should have dimensions matching FFT. |mags| = ${t.length}, |filterbank[0]| = ${n[0].length}.`);const e=new Float32Array(n.length);for(let o=0;o<n.length;o++){const r=m(t,n[o]);e[o]=r.reduce((t,n)=>t+n)}return e}function m(t,n){if(t.length!==n.length)return console.error(`Buffer length ${t.length} != window length ${n.length}.`),null;const e=new Float32Array(t.length);for(let o=0;o<t.length;o++)e[o]=n[o]*t[o];return e}function y(t,n){if(t.length>n)throw new Error("Data is longer than length.");const e=Math.floor((n-t.length)/2);return b(t,[e,n-t.length-e])}function b(t,n){let e,o;"object"==typeof n?[e,o]=n:e=o=n;const r=new Float32Array(t.length+e+o);return r.set(t,e),r}function M(t){const n=new r(t.length),e=n.createComplexArray(),o=n.toComplexArray(t);return n.transform(e,o),e}function x(t){const n=new Float32Array(t);for(let e=0;e<t;e++)n[e]=.5*(1-Math.cos(2*Math.PI*e/(t-1)));return n}function _(t,n,e){const o=(n-t)/(e-1),r=new Float32Array(e);for(let n=0;n<e;n++)r[n]=t+o*n;return r}function v(t){let n=o.sub(t,69);return n=o.div(n,12),n=o.pow(2,n),n=o.mul(440,n),n}async function j(t){let n=o.sub(o.div(o.log(t),o.log(2)),o.div(o.log(440),o.log(2)));n=o.mul(12,n),n=o.add(n,69);return await n.array()}function O(t){return 1125*Math.log(1+t/700)}},,,function(t,n,e){"use strict";e.d(n,"c",(function(){return i})),e.d(n,"b",(function(){return a})),e.d(n,"e",(function(){return u})),e.d(n,"f",(function(){return c})),e.d(n,"d",(function(){return l})),e.d(n,"a",(function(){return f})),e.d(n,"h",(function(){return d})),e.d(n,"g",(function(){return h}));var o=e(0),r=e(8);var s=e(16);const i=16e3,a=250,u=25.58,c=63.07,l=.002,f=.7;async function d(t){let n;return n=await o.loadGraphModel(t,{fromTFHub:!0}),n}async function h(t,n,e){if("webgl"!==o.getBackend())throw new Error("Device does not support webgl.");const u=await Object(r.j)(t,i),c=u.length,l=await async function(t){const n=Math.floor(i/a),e=o.tensor1d(t,"float32"),r=t.length;if(null===e)return[];const s=e.mul(e).reshape([r,1]),u=o.conv1d(s,o.ones([1024,1,1]).div(1024),n,"same").sqrt().squeeze(),c=o.mul(o.log(o.maximum(1e-20,u)).div(o.log(10)),20),l=c.sub(20.7),f=o.maximum(l,-120),d=await f.array();return e.dispose(),s.dispose(),u.dispose(),c.dispose(),l.dispose(),f.dispose(),d}(u),{pitches:f,confidences:d}=await Object(s.a)(n,u,e);return{f0_hz:f,loudness_db:l,confidences:d,originalRecordedBufferLength:c}}},,,,,function(t,n,e){"use strict";e.d(n,"a",(function(){return c})),e.d(n,"b",(function(){return i})),e.d(n,"c",(function(){return a}));var o=e(0),r=e(8),s=e(11);function i(t,n=0){return o.tidy(()=>{let e=o.mul(t,o.pow(2,n));return e=e.clipByValue(0,Object(r.g)(110).dataSync()[0]),e})}function a(t,n,e){return t.splice(e),function(t,n){const e=[],o=Math.floor(n/t.length),r=n%t.length;for(let n=0;n<t.length;n++){e.push(t[n]);for(let t=1;t<o;t++)e.push(-1);n<r&&e.push(-1)}let s=-1;for(let t=0;t<e.length;t++)if(-1!==e[t]){let n=e[t];const o=s>=0?e[s]:0;-1!==s&&(n-=e[s]);for(let r=s+1;r<t;r++)e[r]=o+n*(r-s)/(t-s);s=t}for(let t=s+1;t<e.length;t++)e[t]=s>=0?e[t-1]:0;return e}(t,n)}function u(t){const n=t*s.f+s.e;return 10*Math.pow(2,1*n/12)}async function c(t,n,e=s.a){const r=[],i=[],a=n.length,c=o.tensor(n),l=512*Math.ceil(a/512),f=c.pad([[0,l-a]]),d=f.size/16e3,h=await t.execute({input_audio_samples:f});let g=await h[0].data();const p=await h[1].data();if(32*(p.length-1)/1e3===d){let t=20;for(let n=0;n<p.length;++n){const e=1-g[n];if(i.push(e),e>=s.a)t=u(p[n]),r.push(t);else{const n=o.truncatedNormal([1],0,s.d),e=1-await n.array();r.push(t*e),n.dispose()}}}else{const n=l/512+1,a=new Float32Array(n);g=new Float32Array(n);for(let n=0;n<l;n+=l/4){const e=f.slice([n],[l/4]),o=await t.execute({input_audio_samples:e}),r=await o[0].data(),s=await o[1].data(),i=Math.floor(n/512);g.set(r,i),a.set(s,i),e.dispose(),o[0].dispose(),o[1].dispose()}let c=20;for(let t=0;t<a.length;++t){const n=1-g[t];if(i.push(n),n>=e)c=u(a[t]),r.push(c);else{const t=o.truncatedNormal([1],0,s.d),n=1-await t.array();r.push(c*n),t.dispose()}}}return h[0].dispose(),h[1].dispose(),c.dispose(),f.dispose(),{pitches:r,confidences:i}}},function(t,n){t.exports=require("fft.js")},function(t,n){t.exports=require("node-fetch")},function(t,n,e){"use strict";e.r(n),function(t){e.d(n,"now",(function(){return r})),e.d(n,"timing",(function(){return s}));const o=t.process.hrtime(),r=()=>{const n=t.process.hrtime(o);return n[0]+n[1]/1e9},s={navigationStart:Date.now()}}.call(this,e(20))},function(t,n){var e;e=function(){return this}();try{e=e||new Function("return this")()}catch(t){"object"==typeof window&&(e=window)}t.exports=e},function(t,n,e){"use strict";e.r(n),e.d(n,"userAgent",(function(){return o}));const o=""},function(t,n){t.exports=require("ndarray")},,,,,function(t,n){t.exports=require("ndarray-resample")},,,function(t,n,e){"use strict";e.r(n),e.d(n,"DDSP",(function(){return d}));e(37);var o=e(0),r=e(8),s=e(16),i=e(11),a=e(2);const u=(t,n,e)=>{const o=a.context.createBuffer(1,n.length,e);return o.copyToChannel(n,0),o};function c(t,n,e,o,r){return new Promise(s=>{const i={loudness_db:[0],f0_hz:[0]};let a=0;for(let s=n;s<e;s++)o&&s>=r?(i.loudness_db[a]=-120,i.f0_hz[a]=-1):(i.loudness_db[a]=t.loudness_db[s],i.f0_hz[a]=t.f0_hz[s]),a+=1;s(i)})}function l(t){return t*i.b}function f(t){return t/i.b}class d{constructor(t,n){this.checkpointUrl=t,n&&(this.settings=n)}async initialize(){let t;o.registerOp("Roll",t=>{const n=o.split(t.inputs[0],2,2),e=o.concat([n[1],n[0]],2);return n.forEach(t=>t.dispose()),e}),o.env().set("WEBGL_PACK",!1),o.env().set("WEBGL_CONV_IM2COL",!1),o.env().set("WEBGL_DELETE_TEXTURE_THRESHOLD",104857600),this.model=await async function(t){return await o.loadGraphModel(t)}(this.checkpointUrl+"/model.json");try{t=await fetch(this.checkpointUrl+"/settings.json").then(t=>t.json())}finally{if(null===this.settings)throw new Error("Passing settings is required if you do not have a settings.json file.")}this.settings={...t,...this.settings},this.initialized=!0}dispose(){this.initialized&&(this.model.dispose(),this.checkpointUrl=null,this.initialized=!1)}isInitialized(){return this.initialized}async memCheck(){return await async function(){const t=window.screen.availWidth*window.screen.availHeight,n=window.devicePixelRatio,e=Math.round(t*n*600/1048576);if(!isNaN(e)&&e<50)throw new Error(`Insufficient memory! Your device has ${e} and recommended memory is 50`);try{if(await o.ready(),"webgl"!==o.getBackend())throw new Error("It looks like your browser does not support webgl.")}catch(t){throw new Error("insufficient memory - "+t)}return!0}()}async synthesize(t,n){null!==n&&(this.settings={...this.settings,...n});const{f0_hz:e,loudness_db:d,confidences:h}=t,g=Object(s.c)(e,d.length,this.settings.modelMaxFrameLength),p=Object(s.c)(h,d.length,this.settings.modelMaxFrameLength),w=await async function(t,n){const e=n.averageMaxLoudness,i=n.meanLoudness,a=n.loudnessThreshold,u=n.meanPitch;let c,l=[];if(t.loudness_db.length>0){const n=o.tidy(()=>{const n=o.tensor1d(t.loudness_db,"float32"),r=n.max(),s=o.sub(e,r),i=o.add(n,s);return n.dispose(),r.dispose(),s.dispose(),i}),r=n.greater(a),s=await o.booleanMaskAsync(n,r),u=await s.array(),f=o.tidy(()=>{const t=u>0?s.mean():n.mean(),r=o.sub(i,t),a=n.add(r).add(0).clipByValue(-120,e),c=a.min(),l=t.sub(c);return a.sub(c).div(l).mul(i- -120).add(-120)}),d=o.reshape(t.confidences,[-1,1,1]),h=o.pool(d,[100,1],"avg","same"),g=h.reshape([-1]),p=o.lessEqual(g,.7);c=o.tidy(()=>{const t=p.mul(-25),n=f.add(t),e=o.maximum(n,-120);return t.dispose(),n.dispose(),e}),l=await c.array(),r.dispose(),n.dispose(),f.dispose(),s.dispose(),h.dispose(),g.dispose(),d.dispose(),p.dispose()}let f=[];if(t.f0_hz.length>0){const n=await Object(r.c)(t.f0_hz),e=o.tidy(()=>{for(let t=0,e=n.length;t<e;++t)n[t]===-1/0&&(n[t]=0);return n}),i=o.lessEqual(t.confidences,.7),l=c.greater(a),d=o.logicalOr(i,l),h=await o.booleanMaskAsync(e,d),g=h.mean(),p=await o.sub(u,g),w=await p.array(),m=o.tidy(()=>{let n=w/12;n=Math.round(n);return Object(s.b)(t.f0_hz,n)});f=await m.array(),c.dispose(),g.dispose(),h.dispose(),p.dispose(),m.dispose(),l.dispose(),d.dispose(),i.dispose()}return{f0_hz:f,loudness_db:l}}({f0_hz:g,loudness_db:d,confidences:p},this.settings),m=[],y=w.loudness_db.length,b=f(y);let M=!1;const x=f(this.settings.modelMaxFrameLength);let _;const v=1*i.c;for(let t=0;t<b;t+=x-1){const n=Math.floor(l(t)),e=l(t+x);e>y&&(M=!0);const{f0_hz:r,loudness_db:s}=await c(w,n,e,M,y),i=o.tensor1d(r,"float32"),a=o.tensor1d(s,"float32"),u=await this.model.predict({f0_hz:i,loudness_db:a}),f=await u.data();m.push(f),u.dispose(),i.dispose(),a.dispose()}if(b<=x)_=m[0];else{const t=[];for(let n=0;n<m.length;n++){const e=m[n];t.push(e)}_=function(t,n){const e=t.reduce((t,n)=>t+n.length,0),o=new Float32Array(e);let r=0;for(let e=0;e<t.length;e++){const u=t[e],c=e<t.length-1;if(0===e&&(o.set(u,r),r+=u.length),c){const c=t[e+1],l=r-n;for(let t=l,e=0,f=u.length-n;t<r&&e<c.length;t++,e++,f++){const n=(t-l)/(r-l);o[t]=(s=u[f],i=c[e],s*(1-(a=n))+i*a)}o.set(c.slice(n),r),r+=c.slice(n).length}}var s,i,a;return o}(t,v)}const j=_.slice(0,t.originalRecordedBufferLength).map(t=>t*(this.settings.postGain||1)),O=u(0,j,i.c),A=await Object(r.j)(O,48e3);return await async function({audioCtx:t,arrayBuffer:n,sampleRate:e}){let o,r=u(0,n,e);const s=a.Offline(()=>{const t=new a.Compressor({attack:.001,release:.001,threshold:-6}).toDestination(),n=new a.Reverb({wet:.3,decay:3}).connect(t),e=new a.Filter(8e3,"lowpass",-24).connect(n);return new a.Player({url:r}).connect(e).start(),n.ready},n.length/e);o=await s;const i=o.getChannelData(0);return r=null,o.dispose(),o=null,i}({audioCtx:null,arrayBuffer:A,sampleRate:48e3})}}},,,,,,,function(t,n){t.exports=require("@tensorflow/tfjs-backend-webgl")}])}));